error_log stderr;
pid nginx/nginx.pid;
daemon off;

http {
  # allow 6 requests per min -> one each 10s on avg.
  limit_req_zone $binary_remote_addr zone=mylimit:10m rate=6r/m;

  server {
    listen 127.0.0.1:8090;

    access_log nginx/access_log;

    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    root dist/public;

    location /by-email/ {
      rewrite ^/by-email/([^/][^/])(..*)$ /by-email/$1/$2 break;
      default_type application/pgp-keys;
      try_files /$uri =404;
    }

    location /by-fingerprint/ {
      rewrite ^/by-fingerprint/([^/][^/])(..*)$ $1/$2 break;
      default_type application/pgp-keys;
      try_files /by-fpr/$uri =404;
    }

    location /by-keyid/ {
      rewrite ^/by-keyid/([^/][^/])(.*)$ /by-keyid/$1/$2 break;
      default_type application/pgp-keys;
      try_files /$uri =404;
    }

    location = / {
      proxy_pass http://127.0.0.1:8080;
    }

    location ^~ /vks/ {
      proxy_pass http://127.0.0.1:8080;
    }

    location ^~ /pks/add {
      limit_req zone=mylimit;
      proxy_pass http://127.0.0.1:8080;
    }

    location ^~ /pks/ {
      proxy_pass http://127.0.0.1:8080;
    }
  }
}

events {
  worker_connections 4096;
}
